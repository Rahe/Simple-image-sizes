name: simple-image-sizes
recipe: wordpress
config:
  webroot: ./wordpress/
env:
  - .env.testing
services:
  appserver:
    run_as_root:
      - ln -s /app/ /app/wordpress/wp-content/plugins/simple-image-sizes
  test:
    type: mysql:5.7
    portforward: true
    creds:
      user: test
      password: test
      database: test
  chromedriver:
    type: compose
    services:
      image: robcherry/docker-chromedriver:latest
      expose:
        - "4444"
      environment:
        CHROMEDRIVER_WHITELISTED_IPS: ""
        CHROMEDRIVER_URL_BASE: "/wd/hub"
        CHROMEDRIVER_EXTRA_ARGS: "--ignore-certificate-errors --reduce-security-for-testing --enable-features=NetworkService"
      security_opt:
        - seccomp:unconfined
      command: ["/usr/local/bin/supervisord", "-c", "/etc/supervisord.conf"]
events:
  # Runs composer install and a custom php script before your app starts
  pre-start:
  - appserver: cd $LANDO_MOUNT && composer install
tooling:
  setup:
    service: appserver
    description: 'Setup env'
    cmd:
      - echo "➡️ Reset DB ?"
      - if [ -f /app/wordpress/wp-config.php ]; then echo "wp-config exists reset DB" && wp db reset --yes --path=/app/wordpress ; else echo "No wp-config.php, no reset" ; fi
      - echo "➡️ Reset config"
      - if [ -f /app/wordpress/wp-config.php ]; then echo "wp-config exists deleting it" && rm -f /app/wordpress/wp-config.php; else echo "No wp-config.php, no rm" ; fi
      - echo "➡️ Create config"
      - wp config create --dbname=wordpress --dbuser=wordpress --dbpass=wordpress --dbhost=database --path=/app/wordpress
      - echo "➡️ Install WP"
      - wp core install --url=https://simple-image-sizes.lndo.site --title="Simple image sizes" --admin_user=admin --admin_password=admin --admin_email=admin@admin.fr --path=/app/wordpress --skip-email
      - echo "➡️ Install query monitor"
      - wp plugin install --activate query-monitor --path=/app/wordpress
      - echo "➡️ Activate plugin"
      - wp plugin activate simple-image-sizes --path=/app/wordpress
  test-unit:
      service: appserver
      cmd: composer test-unit
      description: Run our PHPunit tests
  test-wpunit:
      service: appserver
      cmd: composer test-wpunit
      description: Run our wpunit tests
  test-acceptance:
      service: appserver
      cmd: composer test-acceptance
      description: Run our acceptance tests
  test-functional:
      service: appserver
      cmd: composer test-functional
      description: Run our functional tests